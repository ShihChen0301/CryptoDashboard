# CryptoDashboard 功能需求分析報告 v2.0

> **更新日期**：2024-11-25
> **版本**：2.0
> **目的**：分析新功能需求並設計資料庫結構

---

## 📋 功能需求總覽

### ✅ 已支援功能（現有 Schema 可滿足）

| 功能 | 支援狀態 | 資料庫欄位 | 說明 |
|------|---------|-----------|------|
| 使用者&管理者不同權限 | ✅ 已完成 | `users.role` | 支援 'user' 和 'admin' 兩種角色 |
| 使用者輸入交易年齡 | ✅ 已完成 | `users.trading_experience` | 5 個級距：<1年、1-2年、3-5年、5-10年、>10年 |
| Price Chart 多時間區間 | ✅ 前端調整 | 無需資料庫 | 前端呼叫 API 時調整參數（7天、30天、90天、180天、365天、全部） |
| Market Overview 排序 | ✅ 前端調整 | 無需資料庫 | 前端實作每一欄排序功能 |
| 幣種選項擴充 | ✅ API 調整 | 無需資料庫 | 調整 CoinGecko API 參數增加顯示數量 |

### 🆕 需要新增資料庫表格的功能

| 功能 | 需要新表格 | 優先級 | 複雜度 |
|------|-----------|-------|-------|
| 使用者自行新增幣種 + 管理者審核 | ❌ 已取消（不實作） | - | - |
| 多幣比較功能（最多 4 個） | ✅ `coin_comparisons` | 中 | 低 |
| 趨勢圖（買入最多的幣種） | ✅ `user_transactions` | 高 | 高 |

---

## 🗄️ 新增資料庫表格詳細說明

### 提交新幣種（已取消）
- 此功能已取消，不會在平台上線。
- 不建立 `coin_submissions` 資料表，也不開發相關 API/前端。

### 2. coin_comparisons（幣種比較組表）

#### 功能說明
- 使用者可建立多個比較組（例如：「我的投資組合」、「穩定幣比較」）
- 每組最多 4 個幣種
- 可並列顯示價格、漲跌幅、市值等數據

#### 資料表結構
```sql
CREATE TABLE coin_comparisons (
    id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id     BIGINT UNSIGNED NOT NULL,
    name        VARCHAR(100) NOT NULL,              -- 比較組名稱
    coin_ids    JSON NOT NULL,                      -- 幣種 ID 陣列（最多 4 個）
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at  DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT chk_coin_ids_is_array
        CHECK (JSON_TYPE(coin_ids) = 'ARRAY')
);
```

#### 範例數據
```json
{
    "id": 1,
    "user_id": 5,
    "name": "我的投資組合",
    "coin_ids": ["bitcoin", "ethereum", "cardano", "solana"]
}
```

#### 前端頁面需求
1. **比較頁面**（`CompareView.vue` 擴充）
   - 新增：「儲存比較組」按鈕
   - 列表：我的所有比較組（可快速載入）
   - 操作：編輯、刪除比較組

2. **並列顯示**
   - 4 欄並排（響應式設計）
   - 每欄顯示：價格、24h 變化、7d 變化、市值、交易量、圖表

#### API 端點設計
```
POST   /api/comparisons              # 建立比較組
GET    /api/comparisons              # 查詢我的所有比較組
PUT    /api/comparisons/:id          # 更新比較組
DELETE /api/comparisons/:id          # 刪除比較組
```

---

### 3. user_transactions（交易記錄表）

#### 功能說明
- 記錄使用者的買入/賣出交易
- 用途：
  1. Dashboard 顯示「買入最多的幣種」趨勢圖
  2. 個人投資組合分析
  3. 計算持倉與收益

#### 資料表結構
```sql
CREATE TABLE user_transactions (
    id                  BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id             BIGINT UNSIGNED NOT NULL,
    coin_id             VARCHAR(64) NOT NULL,           -- CoinGecko coin id
    transaction_type    ENUM('buy', 'sell') NOT NULL,
    amount              DECIMAL(20, 8) NOT NULL,        -- 數量
    price_at_time       DECIMAL(20, 8) NOT NULL,        -- 成交單價（USD）
    total_value         DECIMAL(20, 8) NOT NULL,        -- 總價值（USD）
    fee                 DECIMAL(20, 8) DEFAULT 0,       -- 手續費
    notes               TEXT NULL,                      -- 備註
    transaction_date    DATETIME NOT NULL,              -- 交易時間（使用者填）
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 前端頁面需求
1. **Dashboard**（`DashboardView.vue` 擴充）
   - 新增：「全平台買入趨勢」圖表
   - 顯示：買入最多的 Top 10 幣種（柱狀圖 / 排行榜）

2. **個人交易頁面**（新增 `PortfolioView.vue`）
   - 表單：新增交易記錄（買入/賣出、幣種、數量、價格、時間）
   - 列表：我的所有交易記錄（可篩選、排序）
   - 統計：
     - 持倉總覽（每個幣種的持有數量、成本、現值、損益）
     - 投資績效（總投入、總價值、總收益率）

3. **個人收益分析**
   - 圖表：持倉分布圓餅圖
   - 圖表：投資收益曲線（時間軸）
   - 排行：收益最高的幣種

#### API 端點設計
```
POST   /api/transactions                          # 新增交易記錄
GET    /api/transactions                          # 查詢我的交易記錄
GET    /api/transactions/portfolio                # 計算我的持倉
GET    /api/transactions/stats/trending-buys      # 全平台買入趨勢（Dashboard 用）
DELETE /api/transactions/:id                      # 刪除交易記錄
```

#### 重要查詢範例

**1. 全平台買入最多的幣種（Dashboard 趨勢圖）**
```sql
SELECT coin_id,
       SUM(amount) AS total_bought,
       COUNT(*) AS transaction_count,
       SUM(total_value) AS total_value_usd
FROM user_transactions
WHERE transaction_type = 'buy'
  AND transaction_date > DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY coin_id
ORDER BY total_bought DESC
LIMIT 10;
```

**2. 計算特定使用者的持倉**
```sql
SELECT coin_id,
       SUM(CASE WHEN transaction_type = 'buy' THEN amount ELSE -amount END) AS holdings,
       SUM(CASE WHEN transaction_type = 'buy' THEN total_value ELSE -total_value END) AS net_cost
FROM user_transactions
WHERE user_id = ?
GROUP BY coin_id
HAVING holdings > 0;
```

---

## 📊 功能實作優先級建議

### 第一階段（核心功能）
1. ✅ **使用者交易記錄**（`user_transactions`）
   - 原因：Dashboard 趨勢圖是主要訴求
   - 工作量：2-3 天（後端 API + 前端頁面 + 圖表）

   - 原因：擴充平台幣種庫
   - 工作量：2 天（後端 API + 管理員審核頁面 + 使用者申請表單）

### 第二階段（增強功能）
3. ✅ **多幣比較功能**（`coin_comparisons`）
   - 原因：提升使用者體驗
   - 工作量：1 天（後端 API + 前端並列顯示）

4. ✅ **Price Chart 多時間區間**
   - 工作量：0.5 天（純前端調整，無需後端）

5. ✅ **Market Overview 排序**
   - 工作量：0.5 天（純前端調整）

---

## 🔄 資料庫升級路徑

### 從 v1 升級到 v2

```sql
-- 執行新表格建立
SOURCE schema_v2.sql;

-- 或僅執行新增部分
CREATE TABLE coin_submissions (...);
CREATE TABLE coin_comparisons (...);
CREATE TABLE user_transactions (...);
```

### 資料遷移
- 無需資料遷移（新表格為全新功能）
- 原有表格（users, auth_tokens, coin_favorites, announcements）完全不變

---

## 📈 各功能的資料庫欄位意義分析

### users 表 - trading_experience 欄位
| 值 | 意義 | 用途 |
|----|------|------|
| `less-than-1` | 新手（< 1 年） | 顯示教學提示、風險警告 |
| `1-2` | 初階（1-2 年） | 推薦適合的分析工具 |
| `3-5` | 中階（3-5 年） | 解鎖進階功能（如合約追蹤） |
| `5-10` | 資深（5-10 年） | 提供專業級數據分析 |
| `more-than-10` | 專家（> 10 年） | 全功能開放 |

### user_transactions 表 - transaction_type 欄位
| 值 | 意義 | 持倉計算 |
|----|------|---------|
| `buy` | 買入 | +amount |
| `sell` | 賣出 | -amount |

---

## 🎯 前端頁面新增/修改清單

### 新增頁面
1. **`PortfolioView.vue`** - 個人投資組合
   - 交易記錄管理
   - 持倉總覽
   - 收益分析

   - 申請表單
   - 我的申請列表

### 修改現有頁面
1. **`DashboardView.vue`**
   - 新增「買入趨勢圖」區塊（取代原本的 Trending Buys 假資料）

2. **`AdminView.vue`**
   - 顯示待審核列表
   - 提供審核操作（通過/拒絕）

3. **`CompareView.vue`**
   - 新增「儲存比較組」功能
   - 新增「我的比較組」列表
   - 支援快速載入已儲存的比較組

---

## 🚀 實作建議

### 後端 (Spring Boot)
1. 建立 3 個新 Entity：
   - `CoinComparison.java`
   - `UserTransaction.java`

2. 建立對應 Repository、Service、Controller

3. 重要 API：
   - `TransactionService.getTrendingBuys()` - 全平台買入趨勢
   - `TransactionService.getUserPortfolio(userId)` - 使用者持倉

### 前端 (Vue 3)
1. 建立新工具函數：
   - `src/utils/transactions.js` - 交易記錄 API
   - `src/utils/comparisons.js` - 比較組 API

2. 建立新組件：
   - `TransactionForm.vue` - 新增交易表單
   - `PortfolioChart.vue` - 投資組合圖表
   - `SubmissionForm.vue` - 申請幣種表單
   - `ComparisonGrid.vue` - 4 欄並列比較

---

## 📝 總結

### 資料庫變更
- **新增 2 個表格**：`coin_comparisons`, `user_transactions`
- **原有表格**：無變更（100% 向下相容）
- **資料遷移**：無需遷移

### 功能完整性
- ✅ 所有需求都已評估
- ✅ 資料庫結構已設計完成
- ✅ 前後端實作方向已規劃

### 下一步
1. 執行 `schema_v2.sql` 建立新表格
2. 後端實作 3 個新 Entity、Repository、Service、Controller
3. 前端實作新頁面與功能
4. 測試與驗證

---

*文檔版本：v2.0*
*最後更新：2024-11-25*
