# å¾Œç«¯ä»£ç¢¼èˆ‡æ•¸æ“šåº«å¯©æŸ¥å ±å‘Š

> **å¯©æŸ¥æ—¥æœŸ**ï¼š2024-11-30
> **å¯©æŸ¥ç¯„åœ**ï¼šå¾Œç«¯ Spring Boot ä»£ç¢¼ã€æ•¸æ“šåº« Schemaã€é…ç½®æ–‡ä»¶
> **å¯©æŸ¥äººå“¡**ï¼šClaude Code
> **å°ˆæ¡ˆç‰ˆæœ¬**ï¼šv1.0.0

---

## ğŸ“Š å¯©æŸ¥ç¸½çµ

### ç™¼ç¾å•é¡Œçµ±è¨ˆ
- **é«˜å„ªå…ˆç´šï¼ˆå®‰å…¨æ€§ï¼‰**ï¼š3 é … âš ï¸âš ï¸âš ï¸
- **ä¸­å„ªå…ˆç´šï¼ˆæ€§èƒ½èˆ‡ä»£ç¢¼è³ªé‡ï¼‰**ï¼š8 é … âš ï¸
- **æ•¸æ“šåº«è¨­è¨ˆå„ªåŒ–**ï¼š5 é …

### æ•´é«”è©•ä¼°
âœ… **å„ªé»**ï¼š
- ä»£ç¢¼çµæ§‹æ¸…æ™°ï¼Œåˆ†å±¤åˆç†
- JWT èªè­‰æ©Ÿåˆ¶å®Œæ•´
- å…¨åŸŸä¾‹å¤–è™•ç†å®Œå–„
- å¿«å–æ©Ÿåˆ¶é…ç½®æ­£ç¢º

âš ï¸ **éœ€è¦æ”¹é€²**ï¼š
- **å®‰å…¨æ€§å•é¡Œåš´é‡**ï¼šæ•æ„Ÿè³‡è¨Šå·²æš´éœ²åœ¨ Git
- ç¼ºå°‘ Rate Limiting é˜²è­·
- æ•¸æ“šåº«éœ€è¦ç´¢å¼•å„ªåŒ–
- Token æ¸…ç†æ©Ÿåˆ¶ç¼ºå¤±

---

## âš ï¸ é«˜å„ªå…ˆç´šå•é¡Œï¼ˆå®‰å…¨æ€§ï¼‰

### å•é¡Œ 1ï¼šæ•æ„Ÿè³‡è¨Šå¤–æ´© âš ï¸âš ï¸âš ï¸

**é¢¨éšªç­‰ç´š**ï¼šğŸ”´ åš´é‡

**å•é¡Œæè¿°**ï¼š
`application.yml` å’Œ `application-dev.yml` åŒ…å«æ•æ„Ÿè³‡è¨Šå·²æäº¤åˆ° Gitï¼š
- æ•¸æ“šåº«å¯†ç¢¼ï¼š`soso0301`
- JWT Secret Key
- CoinGecko API Keyï¼š`CG-vczvnvBTsqG7Z8EVB7KRb3ii`

**å½±éŸ¿**ï¼š
- å¦‚æœ GitHub å€‰åº«æ˜¯å…¬é–‹çš„ï¼Œé€™äº›è³‡è¨Šæœƒè¢«ä»»ä½•äººçœ‹åˆ°
- æ•¸æ“šåº«å¯èƒ½è¢«æœªæˆæ¬Šè¨ªå•
- JWT Token å¯ä»¥è¢«å½é€ 
- API é…é¡å¯èƒ½è¢«æ¿«ç”¨

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

1. **ç«‹å³è®Šæ›´æ‰€æœ‰å¯†ç¢¼å’Œå¯†é‘°**
2. **ä½¿ç”¨ç’°å¢ƒè®Šæ•¸**ï¼š

```yaml
# application.ymlï¼ˆç¯„ä¾‹ï¼‰
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/crypto_dashboard
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD}

jwt:
  secret: ${JWT_SECRET}
  expiration: 86400000

coingecko:
  api:
    key: ${COINGECKO_API_KEY}
```

3. **å‰µå»º `.env` æ–‡ä»¶**ï¼ˆåŠ å…¥ .gitignoreï¼‰ï¼š
```bash
DB_USERNAME=root
DB_PASSWORD=your_new_password
JWT_SECRET=your_strong_secret_key_here
COINGECKO_API_KEY=your_api_key_here
```

4. **æ›´æ–° .gitignore**ï¼š
```gitignore
# Environment variables
.env
.env.local
.env.*.local

# Spring Boot
application-*.yml
!application.yml
!application-dev.yml.example
```

**åƒè€ƒè³‡æ–™**ï¼š
- [Spring Boot Externalized Configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)

---

### å•é¡Œ 2ï¼šJWT Secret å¼·åº¦ä¸è¶³

**é¢¨éšªç­‰ç´š**ï¼šğŸŸ¡ ä¸­ç­‰

**å•é¡Œæè¿°**ï¼š
`application-dev.yml` çš„ JWT secret åªæœ‰ 58 å­—ç¬¦ï¼Œå°æ–¼ HS512 æ¼”ç®—æ³•ä¾†èªªå¼·åº¦ä¸è¶³ã€‚

**å»ºè­°å¯†é‘°é•·åº¦**ï¼š
- HS256ï¼šè‡³å°‘ 256 ä½ï¼ˆ32 å­—ç¯€ï¼Œ43+ Base64 å­—ç¬¦ï¼‰
- HS512ï¼šè‡³å°‘ 512 ä½ï¼ˆ64 å­—ç¯€ï¼Œ86+ Base64 å­—ç¬¦ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

```bash
# ç”Ÿæˆå¼·å¯†é‘°ï¼ˆ64 å­—ç¯€ = 512 ä½ï¼‰
openssl rand -base64 64

# è¼¸å‡ºç¯„ä¾‹ï¼š
# aB3kL9mN2pQ5rS8tU1vW4xY7zA0bC3dE6fG9hI2jK5lM8nN1oP4qR7sT0uV3wX6yZ9
```

æ›´æ–°é…ç½®ï¼š
```yaml
jwt:
  secret: ${JWT_SECRET}  # å¾ç’°å¢ƒè®Šæ•¸è®€å–
```

---

### å•é¡Œ 3ï¼šç¼ºå°‘ Token é»‘åå–®æ©Ÿåˆ¶

**é¢¨éšªç­‰ç´š**ï¼šğŸŸ¡ ä¸­ç­‰

**å•é¡Œæè¿°**ï¼š
ç™»å‡ºå¾Œ Token ä»ç„¶æœ‰æ•ˆï¼ˆJWT ç‰¹æ€§ï¼Œç„¡æ³•çœŸæ­£æ’¤éŠ·ï¼‰ã€‚

**ç•¶å‰å¯¦ä½œ**ï¼š
```java
// AuthService.java:94
public void logout(String token) {
    authTokenRepository.deleteByToken(token);
}
```

åªåˆªé™¤æ•¸æ“šåº«è¨˜éŒ„ï¼Œä½† JWT æœ¬èº«ä»æœ‰æ•ˆï¼ŒæœªéæœŸå‰ä»å¯ä½¿ç”¨ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šåœ¨ JwtAuthenticationFilter æª¢æŸ¥æ•¸æ“šåº«**ï¼ˆæ¨è–¦ï¼Œç°¡å–®ï¼‰

```java
@Override
protected void doFilterInternal(HttpServletRequest request,
                                HttpServletResponse response,
                                FilterChain filterChain) throws ServletException, IOException {
    String authHeader = request.getHeader("Authorization");

    if (authHeader != null && authHeader.startsWith("Bearer ")) {
        String token = authHeader.substring(7);

        try {
            if (jwtUtil.validateToken(token)) {
                // â­ æ–°å¢ï¼šæª¢æŸ¥ Token æ˜¯å¦åœ¨æ•¸æ“šåº«ä¸­
                boolean tokenExists = authTokenRepository.existsByToken(token);
                if (!tokenExists) {
                    logger.debug("Token not found in database (logged out)");
                    filterChain.doFilter(request, response);
                    return;
                }

                Long userId = jwtUtil.getUserIdFromToken(token);
                // ... å…¶é¤˜ä»£ç¢¼
            }
        } catch (Exception e) {
            logger.debug("JWT validation failed: " + e.getMessage());
        }
    }

    filterChain.doFilter(request, response);
}
```

**æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Redis å»ºç«‹ Token é»‘åå–®**ï¼ˆé€²éšï¼Œæ•ˆèƒ½æ›´å¥½ï¼‰

```java
// éœ€è¦æ·»åŠ  Redis ä¾è³´
@Service
public class TokenBlacklistService {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    public void addToBlacklist(String token, long expirationSeconds) {
        redisTemplate.opsForValue().set("blacklist:" + token, "true",
            expirationSeconds, TimeUnit.SECONDS);
    }

    public boolean isBlacklisted(String token) {
        return Boolean.TRUE.equals(
            redisTemplate.hasKey("blacklist:" + token));
    }
}
```

**æ¨è–¦**ï¼šå…ˆå¯¦ä½œæ–¹æ¡ˆ Aï¼ˆç°¡å–®ã€ç„¡éœ€é¡å¤–ä¾è³´ï¼‰ï¼Œæµé‡å¤§æ™‚å†è€ƒæ…® Redisã€‚

---

## ğŸ”§ ä¸­å„ªå…ˆç´šå•é¡Œï¼ˆæ€§èƒ½èˆ‡ä»£ç¢¼è³ªé‡ï¼‰

### å•é¡Œ 4ï¼šN+1 æŸ¥è©¢å•é¡Œ

**ä½ç½®**ï¼š`FavoriteService.getUserFavorites()`

**å•é¡Œæè¿°**ï¼š
å¯èƒ½é€ æˆå¤šæ¬¡æ•¸æ“šåº«æŸ¥è©¢ï¼ˆN+1 å•é¡Œï¼‰ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```java
// CoinFavoriteRepository.java
@Query("SELECT f FROM CoinFavorite f JOIN FETCH f.user WHERE f.user.id = :userId")
List<CoinFavorite> findByUserIdWithUser(@Param("userId") Long userId);
```

---

### å•é¡Œ 5ï¼šAuthService æ¯æ¬¡ç™»å…¥éƒ½åˆªé™¤æ‰€æœ‰èˆŠ Token

**ä½ç½®**ï¼š`AuthService.login():71`

**å•é¡Œæè¿°**ï¼š
```java
authTokenRepository.deleteByUser_Id(user.getId());
```

é€™æœƒåˆªé™¤ç”¨æˆ¶åœ¨æ‰€æœ‰è¨­å‚™çš„ç™»å…¥ç‹€æ…‹ï¼Œå¯èƒ½ä¸æ˜¯æœŸæœ›è¡Œç‚ºã€‚

**å½±éŸ¿**ï¼š
- ç”¨æˆ¶ç„¡æ³•åŒæ™‚åœ¨å¤šå€‹è¨­å‚™ç™»å…¥
- æ‰‹æ©Ÿç™»å…¥æœƒè®“é›»è…¦ç™»å‡º

**å»ºè­°æ–¹æ¡ˆ**ï¼š

**å¦‚æœè¦æ”¯æ´å¤šè¨­å‚™ç™»å…¥**ï¼š
```java
// åªæ¸…ç†éæœŸçš„ Token
authTokenRepository.deleteByUser_IdAndExpiresAtBefore(
    user.getId(),
    LocalDateTime.now()
);
```

**å¦‚æœè¦å–®è¨­å‚™ç™»å…¥**ï¼š
ä¿æŒç¾ç‹€å³å¯ã€‚

---

### å•é¡Œ 6ï¼štoSafeUser ä½¿ç”¨æ‰‹å‹•è¤‡è£½

**ä½ç½®**ï¼š`AuthService.toSafeUser():97-109`

**å•é¡Œæè¿°**ï¼š
æ‰‹å‹•è¤‡è£½å­—æ®µå®¹æ˜“éºæ¼ï¼Œç¶­è­·å›°é›£ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šä½¿ç”¨ DTO**
```java
@Getter
@Setter
public class UserDTO {
    private Long id;
    private String username;
    private String email;
    private String avatarUrl;
    private User.Role role;
    // ...

    public static UserDTO from(User user) {
        UserDTO dto = new UserDTO();
        BeanUtils.copyProperties(user, dto);
        return dto;
    }
}
```

**æ–¹æ¡ˆ Bï¼šä½¿ç”¨ MapStruct**ï¼ˆæ¨è–¦ï¼‰
```java
@Mapper(componentModel = "spring")
public interface UserMapper {
    UserDTO toDTO(User user);
}
```

---

### å•é¡Œ 7ï¼šç¼ºå°‘ Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰

**é¢¨éšªç­‰ç´š**ï¼šğŸŸ¡ ä¸­ç­‰

**å•é¡Œæè¿°**ï¼š
ç™»å…¥ã€è¨»å†Š API æ²’æœ‰é€Ÿç‡é™åˆ¶ï¼Œå®¹æ˜“è¢«æš´åŠ›ç ´è§£ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

ä½¿ç”¨ Bucket4jï¼š

```xml
<dependency>
    <groupId>com.github.vladimir-bukhtoyarov</groupId>
    <artifactId>bucket4j-core</artifactId>
    <version>8.1.0</version>
</dependency>
```

```java
@Configuration
public class RateLimitConfig {

    @Bean
    public Bucket loginRateLimiter() {
        return Bucket.builder()
            .addLimit(Bandwidth.simple(5, Duration.ofMinutes(1)))
            .build();
    }
}
```

```java
@RestController
public class AuthController {

    @Autowired
    private Bucket loginRateLimiter;

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        if (!loginRateLimiter.tryConsume(1)) {
            throw new ValidationException("Too many login attempts. Please try again later.");
        }
        // ... ç™»å…¥é‚è¼¯
    }
}
```

---

### å•é¡Œ 8ï¼šJwtAuthenticationFilter æ—¥èªŒç´šåˆ¥ä¸ç•¶

**ä½ç½®**ï¼š`JwtAuthenticationFilter:53`

**å•é¡Œæè¿°**ï¼š
ä½¿ç”¨ `logger.debug()`ï¼Œç”Ÿç”¢ç’°å¢ƒçœ‹ä¸åˆ°éŒ¯èª¤ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```java
} catch (Exception e) {
    logger.warn("JWT validation failed for token: {}",
        token.substring(0, Math.min(10, token.length())) + "...", e);
}
```

---

### å•é¡Œ 9-11ï¼šå…¶ä»–ä»£ç¢¼è³ªé‡å•é¡Œ

è©³è¦‹ï¼š[å®‰å…¨æ€§å»ºè­°.md](./å®‰å…¨æ€§å»ºè­°.md)

---

## ğŸ—„ï¸ æ•¸æ“šåº«è¨­è¨ˆå„ªåŒ–

### å•é¡Œ 12ï¼šç¼ºå°‘æ•¸æ“šåº«ç´¢å¼•å„ªåŒ–

**å»ºè­°æ·»åŠ è¤‡åˆç´¢å¼•**ï¼š

```sql
-- user_activities è¡¨ - å¸¸è¦‹æŸ¥è©¢ï¼šæŒ‰ç”¨æˆ¶+æ™‚é–“ç¯„åœæŸ¥è©¢æ´»å‹•
CREATE INDEX idx_user_created
ON user_activities(user_id, created_at DESC);

-- auth_tokens è¡¨ - å¸¸è¦‹æŸ¥è©¢ï¼šæŸ¥è©¢æœªéæœŸçš„ Token
CREATE INDEX idx_user_expires
ON auth_tokens(user_id, expires_at);

-- coin_favorites è¡¨ - å·²æœ‰ç´¢å¼•ï¼Œç„¡éœ€èª¿æ•´
-- coin_price_alerts è¡¨
CREATE INDEX idx_active_alerts
ON coin_price_alerts(user_id, is_active, is_triggered);
```

---

### å•é¡Œ 13ï¼šauth_tokens è¡¨ç¼ºå°‘æ¸…ç†æ©Ÿåˆ¶

**å•é¡Œæè¿°**ï¼š
éæœŸ Token æœƒä¸€ç›´ä¿ç•™åœ¨æ•¸æ“šåº«ä¸­ï¼Œæµªè²»ç©ºé–“ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šSpring Scheduled Task**
```java
@Component
public class TokenCleanupTask {

    @Autowired
    private AuthTokenRepository authTokenRepository;

    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2é»
    public void cleanExpiredTokens() {
        int deleted = authTokenRepository.deleteByExpiresAtBefore(LocalDateTime.now());
        log.info("Cleaned {} expired tokens", deleted);
    }
}
```

**æ–¹æ¡ˆ Bï¼šMySQL Event**
```sql
CREATE EVENT clean_expired_tokens
ON SCHEDULE EVERY 1 DAY
DO DELETE FROM auth_tokens WHERE expires_at < NOW();
```

---

### å•é¡Œ 14ï¼šusers è¡¨ç¼ºå°‘è»Ÿåˆªé™¤æ©Ÿåˆ¶

**å•é¡Œæè¿°**ï¼š
ç›´æ¥åˆªé™¤ç”¨æˆ¶æœƒå°è‡´é—œè¯æ•¸æ“šå…¨éƒ¨ä¸Ÿå¤±ï¼ˆCASCADEï¼‰ã€‚

**å»ºè­°**ï¼š
```sql
ALTER TABLE users
ADD COLUMN deleted_at DATETIME NULL,
ADD INDEX idx_deleted_at (deleted_at);
```

```java
// User.java
@Where(clause = "deleted_at IS NULL")
public class User {
    // ...
    private LocalDateTime deletedAt;
}
```

---

### å•é¡Œ 15ï¼šcoin_price_alerts è¡¨ç¼ºå°‘é€šçŸ¥ç‹€æ…‹

**å»ºè­°**ï¼š
```sql
ALTER TABLE coin_price_alerts
ADD COLUMN notification_sent BOOLEAN DEFAULT FALSE,
ADD COLUMN notification_sent_at DATETIME NULL,
ADD INDEX idx_notification_sent (notification_sent);
```

---

## ğŸ¯ å„ªå…ˆåŸ·è¡Œå»ºè­°

### ç«‹å³åŸ·è¡Œï¼ˆå®‰å…¨æ€§ï¼‰âœ…ï¼š
1. âš ï¸âš ï¸âš ï¸ **ç§»é™¤æ•æ„Ÿè³‡è¨Šåˆ°ç’°å¢ƒè®Šæ•¸**ï¼ˆå•é¡Œ 1ï¼‰
2. âš ï¸ **æ›´æ–° JWT Secret**ï¼ˆå•é¡Œ 2ï¼‰
3. âš ï¸ **æ·»åŠ  JwtAuthenticationFilter æ•¸æ“šåº«æª¢æŸ¥**ï¼ˆå•é¡Œ 3ï¼‰

### çŸ­æœŸå„ªåŒ–ï¼ˆ1-2é€±ï¼‰ï¼š
4. æ·»åŠ  Rate Limitingï¼ˆå•é¡Œ 7ï¼‰
5. å¯¦ä½œéæœŸ Token æ¸…ç†æ©Ÿåˆ¶ï¼ˆå•é¡Œ 13ï¼‰
6. å„ªåŒ–æ•¸æ“šåº«ç´¢å¼•ï¼ˆå•é¡Œ 12ï¼‰

### é•·æœŸå„ªåŒ–ï¼ˆå¾ŒçºŒè¿­ä»£ï¼‰ï¼š
7. æ·»åŠ å–®å…ƒæ¸¬è©¦
8. æ•´åˆ API æ–‡æª”ï¼ˆSwagger/SpringDocï¼‰
9. å¯¦ä½œè»Ÿåˆªé™¤æ©Ÿåˆ¶ï¼ˆå•é¡Œ 14ï¼‰
10. å„ªåŒ–ä»£ç¢¼è³ªé‡ï¼ˆå•é¡Œ 4-6, 8-11ï¼‰

---

## ğŸ“š åƒè€ƒè³‡æ–™

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Spring Security Reference](https://docs.spring.io/spring-security/reference/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [MySQL Performance Optimization](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)

---

**å¯©æŸ¥å®Œæˆæ—¥æœŸ**ï¼š2024-11-30
**ä¸‹æ¬¡å¯©æŸ¥å»ºè­°æ™‚é–“**ï¼šå®‰å…¨æ€§å„ªåŒ–å®Œæˆå¾Œ
